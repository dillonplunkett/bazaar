{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% from "helpers.js" import autocomplete %}

{% block app_content %}
    <h1>Auction {{ auction.id }}</h1>
    <hr/>
    <h2>Balances:</h2>
    <ul>
        {% for balance in auction.balances %}
            {% if balance.holder == current_user %}<b>{% endif %}
            <li>
                {{ balance.holder.username }}: {{ balance.amount }}
                {% if lot and lot.max_bid().bidder == balance.holder and not waiting_on %}
                    <span style="color: red;">(-{{ lot.max_bid().amount }})</span>
                {% endif %}
            </li>
            {% if balance.holder == current_user %}</b>{% endif %}
        {% endfor %}
    </ul>
    <hr/>
    {% if lot %}
        {% if card_names %}
            <h2>Current Lot:</h2>
            {% for card in card_names %}
                <img src="{{ url_for('static', filename='card_images/'+ card.replace(' ', '_') + '.jpg') }}" width="24%"/>
            {% endfor %}
        {% else %}
            <p>Place your bid.</p>
        {% endif %}
        <hr/>
        {% if not waiting_on %}
            <h3>Bids:</h3>
            <ul>
            {% for bid in lot.max_bids() %}
                {% if bid == lot.max_bid() %}<span style="color: green;">{% endif %}
                {% if bid %}
                    <li>{{ bid.bidder.username }}: {{ bid.amount }}</li>
                {% endif %}
                {% if bid == lot.max_bid() %}</span>
                {% endif %}
            {% endfor %}
            </ul>
            {% if auction.creator == current_user %}
            <form action="" method="post">
                {{ advance_form.hidden_tag() }}
                {{ wtf.form_field(advance_form.next_lot, autofocus=true) }}
                {{ wtf.form_field(advance_form.submit_advance) }}
                {{ wtf.form_field(advance_form.submit_reset, onclick="return confirm('Are you sure you want to reset bids on this lot?');") }}
            </form>
            {% endif %}
        {% elif current_user.has_funds(auction) %}
            <form action="" method="post">
                {{ bid_form.hidden_tag() }}
                {{ wtf.form_field(bid_form.amount, autofocus=true) }}
                {{ wtf.form_field(bid_form.submit_bid) }}
            </form>
            {% if auction.creator == current_user %}
            <br/>
            <form action="" method="post">
                {{ close_bidding_form.hidden_tag() }}
                {{ wtf.form_field(close_bidding_form.submit_close, onclick="return confirm('Are you use you want to close bidding?');") }}
            </form>
            {% endif %}
        {% else %}
            <p>You have no funds left for this auction.</p>
        {% endif %}
    {% else %}
        <h2>Auction Complete!</h2>
    {% endif %}
    <hr/>
    <h2>Picks:</h2>
    {% include "pick_links.html" %}
{% endblock %}

{% block app_scripts %}
    <script>
        function refresh_auction(msg) {
            if (msg["auction.id"] === {{ auction.id}}) {
                window.location.href = window.location.href;
            }
        }
        $(document).ready(function() {
            var socket = io.connect();
            {% if waiting_on and current_user not in waiting_on %}
                socket.on("a bid", refresh_auction);
                // just in case
                setTimeout(function() {
                   window.location.href = window.location.href;
                }, 10000);
            {% endif %}
            socket.on("next lot", refresh_auction);
            socket.on("reset", refresh_auction);
            socket.on("some bidders skipped", refresh_auction);

            {{ autocomplete("next_lot", auction.pool.cards) }}
        });
    </script>
{% endblock %}
